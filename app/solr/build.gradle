import org.apache.tools.ant.filters.*

project.description = "Solr Builder"

defaultTasks 'install'

// START Configuration variables ------------------------------------------
def instance_number = 3				
def collectionName = "udid"
def solrBaseDir = "$buildDir/solr_home"
def hostName = "localhost"
def shardNumbers = 1
def replicationFactor = 1
def output = "$buildDir/solr_output.properties"
// END Configuration variables ---------------------------------------------

// Data from Tomcat build file output --------------------------------------										
def tomcatPort = "8082"
def catalinaHome = "C:\\Users\\Vtssogari\\Documents\\GitHub\\automateScript\\web\\tomcat\\build\\tomcat\\tomcat7_3\\apache-tomcat-7.0.34"

// Data from Zookeeper build file output------------------------------------
def isSolrCloud = true
def zkHost = "localhost:2181,localhost:2182,localhost:2183"

// Build script configuration ----------------------------------------------
def install_solr_dir = "install/apache-solr-4.1"
def install_zkCli_dir = "install/SolrZKCli/lib"
def install_solr4war = install_solr_dir + "/dist/apache-solr-4.1-2013-01-07_23-32-20.war"

def solrHomeDir = solrBaseDir + "/solr_home_" + instance_number
def tomcatWebappsDir = catalinaHome + '/webapps'
def tomcatBinDir = catalinaHome + '/bin'
def install_tomcat_solrConfig = "template/tomcat_context/solr.xml"
def install_solrHome = "template/solr_home"
def install_solrXML = "template/solr_cloud_solr_xml"

task deploySolrWarToTomcat(type: Copy) {
	def sourceFile = file(install_solr4war)
	def targetDir = file(tomcatWebappsDir)
	from sourceFile
	into targetDir
	rename (sourceFile.name, 'solr.war')
}

task copySolrContextXml(type: Copy, dependsOn: deploySolrWarToTomcat) {
	def sourceDir = file(install_tomcat_solrConfig)
	def targetDir = file(catalinaHome + '/conf/Catalina/localhost')
	def solrHomePath = file(solrHomeDir).absolutePath
	def solrWarPath = file(tomcatWebappsDir + "/solr.war").absolutePath 
	from sourceDir
	into targetDir
	filter(ReplaceTokens, tokens: [tomcat_solr_war: solrWarPath, solr_home_location: solrHomePath])
}

task copySolrHome(type: Copy, dependsOn: copySolrContextXml) {
	def sourceDir = file(install_solrHome)
	def targetDir = file(solrHomeDir)
	from sourceDir
	into targetDir
}

task copyCloudSolrHome(type: Copy, dependsOn: copySolrContextXml) {
	def sourceDir = file(install_solrXML)
	def targetDir = file(solrHomeDir)
	from sourceDir
	into targetDir
}

String getSolrOpts(String solrHome, String port, String zkHost, boolean isWindows, boolean isSolrCloud) {
	String result = null
	def SOLR_OPTS = 'SOLR_OPTS=-Dsolr.solr.home="'+solrHome+'"'
	if(isSolrCloud){
		SOLR_OPTS += ' -Dport=' + port + ' -DhostContext=solr -DzkClientTimeout=20000 -DzkHost="' + zkHost +'"'
	}
	if(isWindows){
		result = System.getProperty("line.separator") + "set " + SOLR_OPTS
		result += System.getProperty("line.separator") + "set JAVA_OPTS=%JAVA_OPTS% %SOLR_OPTS%"
	}else{
		result = System.getProperty("line.separator") + SOLR_OPTS
		result += System.getProperty("line.separator") + 'JAVA_OPTS="$JAVA_OPTS $SOLR_OPTS"'
	}
	return result
}


task install() {
	println "install.doFirst"
	if(isSolrCloud){
		tasks.copySolrHome.enabled = false
	}else{
		tasks.copyCloudSolrHome.enabled = false
	}
	
	def setEvnBatFile = file(tomcatBinDir + "/setenv.bat")
	def setEvnShFile = file(tomcatBinDir + "/setenv.sh")
	setEvnBatFile.append(getSolrOpts(solrHomeDir, tomcatPort, zkHost, true, isSolrCloud))
	setEvnShFile.append(getSolrOpts(solrHomeDir, tomcatPort, zkHost, false, isSolrCloud))
	println "Done"
}

install.dependsOn copySolrHome, copyCloudSolrHome

task generateRestAPIUrl(){
	def baseUrl = 'http://' + hostName + ':' + tomcatPort 
	//1. create collection
	def createCollectionUrl = baseUrl + '/solr/admin/collections?action=CREATE&name=' + collectionName + '&numShards=' + '&replicationFactors=' + replicationFactor 
	//2. delete collection
	def deleteCollectionUrl = baseUrl + '/solr/admin/collections?action=DELETE&name=' + collectionName
	//3. create core
	def createCoreUrl = baseUrl + '/solr/admin/cores?action=CREATE&name=' + collectionName + '&collection=' + collectionName
	
	
	def ofile = file(output)
	ofile.createNewFile()
	String content = "createCollectionUrl=" + createCollectionUrl + System.getProperty("line.separator")
	content += "deleteCollectionUrl=" + deleteCollectionUrl + System.getProperty("line.separator")
	content += "createCoreUrl=" + createCoreUrl + System.getProperty("line.separator")
	ofile.write(content)
	
}

task uploadSolrConfigToZk(type:Exec, dependsOn: generateRestAPIUrl) {

	//1. download solr build or nightly build
	//2. unzip solr
	//3. locate apache-solr-4.1-xxxx.war
	//4. rename it to solr.war
	//5. unzip and move files to cli folder
	//6. run cli command to upload conf folder
	//7. deploy war file
	//new File(oldFilename).renameTo(new File(newFilename))
		
	String zkCliDir = file(install_zkCli_dir).absolutePath
	def commandToExecute = 'java -classpath "' + zkCliDir + '/*" org.apache.solr.cloud.ZkCLI -cmd upconfig -confdir "' + solrHomeDir + '" -confname ' + collectionName + ' -zkhost ' + zkHost
	
	println commandToExecute
	workingDir "./"
	if(isWindowsEnv()){
		//on windows:
		commandLine 'cmd', '/c', commandToExecute
	}else{
		//on linux
		commandLine commandToExecute
	}
	standardOutput = new ByteArrayOutputStream()
	//extension method stopTomcat.output() can be used to obtain the output:
	ext.output = {
		return standardOutput.toString()
	}
}

boolean isWindowsEnv() {
	def os = System.getProperty("os.name").toLowerCase() 
	return os.contains("windows");
}

task clean(type: Delete) {
   delete solrHomeDir
}

task wrapper(type: Wrapper) {
    gradleVersion = '1.3'
}




